<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Orion - Agente Conversacional + Herramientas CSV / IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
    h1 {
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
    body {
      background: #0f172a;
      color: #e2e8f0;
      transition: background 0.4s, color 0.4s;
    }
    .msg-user {
      background: rgb(101, 167, 101);
      color: white;
      border-radius: 1rem 1rem 0 1rem;
    }
    .msg-agent {
      background: #5f708d;
      color: #f1f5f9;
      border-radius: 1rem 1rem 1rem 0;
    }
    .scrollbar::-webkit-scrollbar { width: 8px; }
    .scrollbar::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 4px;
    }
  </style>
</head>

<body class="flex flex-col items-center min-h-screen p-6">
  <div class="w-full max-w-3xl bg-gray-900 border border-gray-700 rounded-2xl shadow-lg p-6">
    <h1 class="text-3xl font-bold text-center text-green-400 mb-4">
      🤖 Orion
    </h1>

    <!-- Subir CSV -->
    <form id="csvForm" class="flex flex-col sm:flex-row gap-3 items-center justify-center border-b border-gray-700 pb-4 mb-4">
      <label class="font-medium text-gray-300">📂 Subir archivo CSV:</label>
      <input type="file" id="csvfile" accept=".csv"
        class="border border-gray-600 bg-gray-800 text-gray-100 rounded-lg p-2 text-sm">
      <button type="submit"
        class="bg-blue-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
        Subir
      </button>
      <button id="analyzeBtn"
        class="bg-green-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition hidden">
        📈 Analizar CSV
      </button>
    </form>

    <div id="csv_result" class="text-sm text-green-400 mb-4 text-center"></div>

    <!-- Chat -->
    <div id="chatlog" class="scrollbar border border-gray-700 rounded-xl p-4 h-80 overflow-y-scroll bg-gray-800 mb-4"></div>

    <!-- Enviar mensaje -->
    <form id="chatForm" class="flex gap-3 items-center">
      <button type="button" id="voiceBtn"
        class="bg-blue-600 hover:bg-green-700 text-white px-3 py-2 rounded-full transition"
        title="Hablar con Orion 🎙️">
        🎙️
      </button>
      <input type="text" id="usermsg" placeholder="💬 Escribe o habla tu mensaje aquí..."
        class="flex-grow border border-gray-600 bg-gray-800 text-gray-100 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl transition">
        Enviar
      </button>
    </form>

    <!-- Imagen / gráfico -->
    <div id="img" class="mt-6 text-center"></div>
  </div>

  <script>
  const chatlog = document.getElementById("chatlog");
  let chat_history = [];

  // 🎤 Voz a texto (SpeechRecognition)
  const voiceBtn = document.getElementById("voiceBtn");
  const userInput = document.getElementById("usermsg");

  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = "es-ES";
    recognition.continuous = false;
    recognition.interimResults = false;

    voiceBtn.onclick = () => {
      recognition.start();
      voiceBtn.textContent = "🎧 Escuchando...";
      voiceBtn.classList.add("bg-yellow-600");
    };

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      voiceBtn.textContent = "🎙️";
      voiceBtn.classList.remove("bg-yellow-600");
    };

    recognition.onerror = () => {
      voiceBtn.textContent = "🎙️";
      voiceBtn.classList.remove("bg-yellow-600");
      alert("No se pudo reconocer tu voz. Intenta de nuevo.");
    };
  } else {
    voiceBtn.disabled = true;
    voiceBtn.textContent = "🚫";
    voiceBtn.title = "Tu navegador no soporta reconocimiento de voz";
  }

  // 📂 Subir archivo CSV
  document.getElementById("csvForm").onsubmit = async function(e) {
      e.preventDefault();
      let f = document.getElementById("csvfile").files[0];
      if (!f) return alert("Selecciona un archivo CSV primero.");
      let form = new FormData();
      form.append("file", f);
      let r = await fetch("https://orionxgemini.onrender.com/upload", {method:"POST", body:form});
      let j = await r.json();
      document.getElementById("csv_result").textContent = "✅ Archivo cargado: " + j.filename;
      document.getElementById("analyzeBtn").classList.remove("hidden");
  };

  // 📈 Analizar CSV
  document.getElementById("analyzeBtn").onclick = async function() {
      chat_history.push({role: 'user', msg: "Analiza el CSV"});
      render_chat();
      const r = await fetch("https://orionxgemini.onrender.com/analizar_csv", {method:"POST"});
      const j = await r.json();
      chat_history.push({role: 'agent', msg: j.response});
      render_chat();
  };

  // 💬 Enviar mensaje
  document.getElementById("chatForm").onsubmit = async function(e) {
    e.preventDefault();
    const usermsg = userInput.value.trim();
    if (!usermsg) return;
    chat_history.push({role: 'user', msg: usermsg});
    render_chat();
    userInput.value = "";

    let endpoint = "https://orionxgemini.onrender.com/chat";
    let form = new FormData();

    form.append("user_message", usermsg);

    // 🚀 Enviar solicitud
    const r = await fetch(endpoint, {method: "POST", body: form});
    const j = await r.json();
    chat_history.push({role: 'agent', msg: j.response});
    if (j.graphic)
      document.getElementById("img").innerHTML = `
        <p class="font-medium mb-2 text-gray-300">📊 Última gráfica generada:</p>
        <img class="rounded-lg shadow-md mx-auto max-w-md border border-gray-700" src="https://orionxgemini.onrender.com/image/${j.graphic}">
      `;
    else
      document.getElementById("img").innerHTML = '';
    render_chat();
  };

  // 💬 Mostrar chat
  function render_chat() {
      chatlog.innerHTML = '';
      for (let c of chat_history) {
          let div = document.createElement("div");
          div.className = "my-2 flex " + (c.role === 'user' ? "justify-end" : "justify-start");
          div.innerHTML = `
              <div class="${c.role === 'user' ? 'msg-user' : 'msg-agent'} px-4 py-2 max-w-[75%] shadow-sm whitespace-pre-wrap">
                  ${c.msg}
              </div>`;
          chatlog.appendChild(div);
      }
      chatlog.scrollTop = chatlog.scrollHeight;
  }
  </script>
</body>
</html>

